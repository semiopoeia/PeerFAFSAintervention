**examining and cleaning data
**empty column
drop BT
**some vars need destringing
*FAFSA return vars have value code for <5, i am truncating at 5
local FAFSA "FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 FAFSA_3_3_17"
foreach f of local FAFSA{
replace `f'="5" if `f'=="<5"
}
**we also have a set of vars which truncate at 10, so they have codes for <10 at the lower bound, set to 10
local strcov "SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalAdvanced_2016_Science TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Social_S TotalNotProficient_2016_Science TotalSurpassed_2016_Social_Studi TotalSurpassed_2016_Science TotalAttained_2016_Social_Studie TotalAttained_2016_Science TotalEmergingTowards_2016_Social TotalEmergingTowards_2016_Scienc TotalMet_2016_Social_Studies TotalMet_2016_Science TotalDidNotMeet_2016_Social_Stud TotalDidNotMeet_2016_Science TotalAdvanced_2016_Social_Studie TotalAttained_2016_Social_Studie TotalAdvanced_2016_Science TotalAttained_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
foreach s of local strcov{
replace `s'="10" if `s'=="<10"
}
replace MathPercentReady_2016="10" if MathPercentReady_2016=="<10%"
replace MathPercentReady_2016="5" if MathPercentReady_2016=="<5%"
**now to destring
local strvar "FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 FAFSA_3_3_17 SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalAdvanced_2016_Science TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Social_S TotalNotProficient_2016_Science TotalSurpassed_2016_Social_Studi TotalSurpassed_2016_Science TotalAttained_2016_Social_Studie TotalAttained_2016_Science TotalEmergingTowards_2016_Social TotalEmergingTowards_2016_Scienc TotalMet_2016_Social_Studies TotalMet_2016_Science TotalDidNotMeet_2016_Social_Stud TotalDidNotMeet_2016_Science TotalAdvanced_2016_Social_Studie TotalAttained_2016_Social_Studie TotalAdvanced_2016_Science TotalAttained_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
destring `strvar',force replace
**scan for high missing vars, drop if <222 (less than 20% values present)
sum _all
drop TotalSurpassed_2016_Social_Studi TotalSurpassed_2016_Science TotalAttained_2016_Social_Studie TotalAttained_2016_Science TotalEmergingTowards_2016_Social TotalEmergingTowards_2016_Scienc FIRST_YEAR_FIRST_TIME_COUNT_Coll MathPercentReady_2016
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MIfull1.dta",replace

**start setting data for FAFSA mining
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MIfull1.dta", clear
sort Unique_ID
drop if FAFSA_3_3_17==.
tab Treatment
**all treatment still intact
drop Unique_ID ISDCode ISDName DistrictCode DistrictName BuildingName Treatment LOCALE_NAME City EntityType
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_FAFSA_mine.dta",replace
*******go into R to mine for most important predictors on FAFSA returns
**all the predictors had influence greater than .01, so they'll all be retained to create propensity scores on the treatment
**now to make a mining set for the treatment
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MIfull1.dta", clear
**sorting by ID is key because it is removed for mining purposes thus we need to be able to merge by observation
sort Unique_ID
**keep outcome from influencing propensity by removing it along with strings
drop Unique_ID ISDCode ISDName DistrictCode DistrictName BuildingName FAFSA_3_3_17 LOCALE_NAME City EntityType
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_treat_mine.dta",replace
**boosting is making perfect separation moving into less stringent classifier
**first try logit
local preds "Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 HAWAIIAN_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 CONTINUING_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014 MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalNotProficient_2016_Social_S TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Social_Stud TotalAdvanced_2016_Science TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Science TotalMet_2016_Science TotalDidNotMeet_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
logit Treatment `preds'
**too much missing, drops all Treatment
**can try running only on complete cases (p=53)
egen ms=rowmiss(_all)
sum ms
**no cases have complete cases, retain only variables that are complete (n-1,133)
sum _all
drop ms
keep Treatment Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 HAWAIIAN_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 CONTINUING_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014
logit Treatment Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 HAWAIIAN_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 CONTINUING_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014
**collinearity issue is estimating propensity
**try linear predictor via SEM with fiml
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_treat_mine.dta",replace
local preds "Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 HAWAIIAN_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 CONTINUING_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014 MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalNotProficient_2016_Social_S TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Social_Stud TotalAdvanced_2016_Science TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Science TotalMet_2016_Science TotalDidNotMeet_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
sem (Treatment<- `preds',), method(mlmv) nocapslatent
**can't estimate initial values (probably singularity in model covariance matrix)
**try modeling with latent var for indicators
local preds "Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 HAWAIIAN_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 CONTINUING_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014 MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalNotProficient_2016_Social_S TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Social_Stud TotalAdvanced_2016_Science TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Science TotalMet_2016_Science TotalDidNotMeet_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
sem (Treatment<-L1,) (L1->`preds',),method(mlmv) nocapslatent latent(L1)
**unsurprisingly, same issue
**try one by one eliminations
local preds "Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 HAWAIIAN_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 CONTINUING_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014 MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalNotProficient_2016_Social_S TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Social_Stud TotalAdvanced_2016_Science TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Science TotalMet_2016_Science TotalDidNotMeet_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
foreach x of local preds{ 
	logit Treatment `x'
}
*explore one by one
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MIfull1.dta", clear
**African American enrollment significantly differs, use exclusion
sort Treatment
by Treatment: sum AFRICAN_AMERICAN_ENROLLMENT_2017
**lowest peer forward school in michigan has N=48 and highest N=426
drop if AFRICAN_AMERICAN_ENROLLMENT_2017<48
drop if AFRICAN_AMERICAN_ENROLLMENT_2017>426
**Hawaiian enrollment is excluded because within treatment there are no hawaiian, exclude var

**no continuing_6_year_2014 in treatment, exclude

**mathscore avearage 2016 says perfect prediction issues, will need to investigate
sort Treatment
by Treatment: sum MathScoreAverage_2016
**lowest peer forward is 356.7 and highest 476.1, controls go above and below
drop if MathScoreAverage_2016<356.7
drop if MathScoreAverage_2016>476.1
tab Treatment
**143 controls, 6 treatment(i.e., all treatment cases retained)
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_trim1.dta",replace
**now try linear predictor again
local preds "Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 FAFSA_6_30_16 FAFSA_12_30_16 FAFSA3_3_16 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014 MathScoreAverage_2016 TotalAdvanced_2016_Social_Studie TotalProficient_2016_Social_Stud TotalPartiallyProficient_2016_So TotalNotProficient_2016_Social_S TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Social_Stud TotalAdvanced_2016_Science TotalProficient_2016_Science TotalPartiallyProficient_2016_Sc TotalNotProficient_2016_Science TotalMet_2016_Science TotalDidNotMeet_2016_Science TOTAL_Graduate_COUNT_CER_2015 TotalGraduatesAllStudents_C TotalEnrolledinanIHEwithin"
sem (Treatment<- `preds',), method(mlmv) nocapslatent
**again initial values not feasible, likely that singularity is worse with the smaller sample, trying for completes vars again
***create file and go back into R
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_trim1.dta", clear
keep Treatment Grade_12_ENROLLMENT_2016 GRADE_12_ENROLLMENT_2017 TOTAL_ENROLLMENT_2017 MALE_ENROLLMENT_2017 FEMALE_ENROLLMENT_2017 AMERICAN_INDIAN_ENROLLMENT_2017 ASIAN_ENROLLMENT_2017 AFRICAN_AMERICAN_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 WHITE_ENROLLMENT_2017 TWO_OR_MORE_RACES_ENROLLMENT_201 ECONOMIC_DISADVANTAGED_ENROLLMEN SPECIAL_EDUCATION_ENROLLMENT_201 ENGLISH_LANGUAGE_LEARNERS_ENROLL GRADUATION_RATE_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 GRADUATES_4_YEAR_2016 DROPOUTS_4_YEAR_2016 CONTINUING_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016 GRADUATION_RATE_5_YEAR_2015 DROPOUT_RATE_5_YEAR_2015 GRADUATES_5_YEAR_2015 DROPOUTS_5_YEAR_2015 CONTINUING_5_YEAR_2015 OTHER_COMPLETER_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014 DROPOUT_RATE_6_YEAR_2014 GRADUATES_6_YEAR_2014 DROPOUTS_6_YEAR_2014 OTHER_COMPLETER_6_YEAR_2014
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_treat_mine2.dta",replace
**still perfect separation

**explore set of covariates in new sample, covariates are ordered according to relative influence from boosting in R
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_trim1.dta", clear
drop HAWAIIAN_ENROLLMENT_2017 CONTINUING_6_YEAR_2014 
local covset "FAFSA_6_30_16	FAFSA_12_30_16 TotalProficient_2016_Social_Stud	TotalAdvanced_2016_Social_Studie FAFSA3_3_16 TotalPartiallyProficient_2016_Sc TotalAdvanced_2016_Science TotalProficient_2016_Science FEMALE_ENROLLMENT_2017 TOTAL_Graduate_COUNT_CER_2015 GRADE_12_ENROLLMENT_2017	TotalEnrolledinanIHEwithin GRADUATES_6_YEAR_2014 TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Science AFRICAN_AMERICAN_ENROLLMENT_2017	TotalNotProficient_2016_Social_S TOTAL_ENROLLMENT_2017	ASIAN_ENROLLMENT_2017	TotalPartiallyProficient_2016_So	TotalDidNotMeet_2016_Social_Stud	TotalMet_2016_Science	GRADUATION_RATE_4_YEAR_2016	TotalGraduatesAllStudents_C	TotalNotProficient_2016_Science	Grade_12_ENROLLMENT_2016	MathScoreAverage_2016	GRADUATES_5_YEAR_2015	GRADUATION_RATE_6_YEAR_2014	MALE_ENROLLMENT_2017	SPECIAL_EDUCATION_ENROLLMENT_201	TWO_OR_MORE_RACES_ENROLLMENT_201	WHITE_ENROLLMENT_2017	HISPANIC_ENROLLMENT_2017	GRADUATION_RATE_5_YEAR_2015	ECONOMIC_DISADVANTAGED_ENROLLMEN	DROPOUT_RATE_6_YEAR_2014	ENGLISH_LANGUAGE_LEARNERS_ENROLL	CONTINUING_4_YEAR_2016	DROPOUT_RATE_4_YEAR_2016	OTHER_COMPLETER_4_YEAR_2016	DROPOUTS_6_YEAR_2014	GRADUATES_4_YEAR_2016	DROPOUT_RATE_5_YEAR_2015	OTHER_COMPLETER_6_YEAR_2014	DROPOUTS_5_YEAR_2015  AMERICAN_INDIAN_ENROLLMENT_2017	CONTINUING_5_YEAR_2015	DROPOUTS_4_YEAR_2016	OTHER_COMPLETER_5_YEAR_2015"
foreach x of local covset{
logit Treatment `x',vce(robust)
}

local covset "FAFSA_6_30_16	FAFSA_12_30_16 TotalProficient_2016_Social_Stud	FAFSA3_3_16 TotalPartiallyProficient_2016_Sc TotalAdvanced_2016_Science TotalProficient_2016_Science FEMALE_ENROLLMENT_2017 TOTAL_Graduate_COUNT_CER_2015 GRADE_12_ENROLLMENT_2017	TotalEnrolledinanIHEwithin GRADUATES_6_YEAR_2014 TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Science AFRICAN_AMERICAN_ENROLLMENT_2017	TotalNotProficient_2016_Social_S TOTAL_ENROLLMENT_2017	ASIAN_ENROLLMENT_2017 TotalPartiallyProficient_2016_So TotalDidNotMeet_2016_Social_Stud TotalMet_2016_Science GRADUATION_RATE_4_YEAR_2016	TotalGraduatesAllStudents_C	TotalNotProficient_2016_Science	Grade_12_ENROLLMENT_2016 MathScoreAverage_2016	GRADUATES_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014	MALE_ENROLLMENT_2017 SPECIAL_EDUCATION_ENROLLMENT_201 TWO_OR_MORE_RACES_ENROLLMENT_201 WHITE_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 GRADUATION_RATE_5_YEAR_2015 ECONOMIC_DISADVANTAGED_ENROLLMEN DROPOUT_RATE_6_YEAR_2014 ENGLISH_LANGUAGE_LEARNERS_ENROLL CONTINUING_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016	DROPOUTS_6_YEAR_2014 GRADUATES_4_YEAR_2016 DROPOUT_RATE_5_YEAR_2015 OTHER_COMPLETER_6_YEAR_2014 DROPOUTS_5_YEAR_2015 AMERICAN_INDIAN_ENROLLMENT_2017 CONTINUING_5_YEAR_2015 DROPOUTS_4_YEAR_2016 OTHER_COMPLETER_5_YEAR_2015"
foreach x of local covset{
sem (Treatment<-`x',),method(mlmv) nocapslatent vce(robust)
}
**TotalAdvanced_2016_Social_Studie, TotalAdvanced_2016_Science are unobserved in Treatment, remove from analysis
local covset2 "FAFSA_6_30_16 FAFSA_12_30_16 TotalProficient_2016_Social_Stud	FAFSA3_3_16 TotalPartiallyProficient_2016_Sc TotalProficient_2016_Science FEMALE_ENROLLMENT_2017 TOTAL_Graduate_COUNT_CER_2015 GRADE_12_ENROLLMENT_2017	TotalEnrolledinanIHEwithin GRADUATES_6_YEAR_2014 TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Science AFRICAN_AMERICAN_ENROLLMENT_2017	TotalNotProficient_2016_Social_S TOTAL_ENROLLMENT_2017	ASIAN_ENROLLMENT_2017 TotalPartiallyProficient_2016_So TotalDidNotMeet_2016_Social_Stud TotalMet_2016_Science GRADUATION_RATE_4_YEAR_2016	TotalGraduatesAllStudents_C	TotalNotProficient_2016_Science	Grade_12_ENROLLMENT_2016 MathScoreAverage_2016	GRADUATES_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014	MALE_ENROLLMENT_2017 SPECIAL_EDUCATION_ENROLLMENT_201 TWO_OR_MORE_RACES_ENROLLMENT_201 WHITE_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 GRADUATION_RATE_5_YEAR_2015 ECONOMIC_DISADVANTAGED_ENROLLMEN DROPOUT_RATE_6_YEAR_2014 ENGLISH_LANGUAGE_LEARNERS_ENROLL CONTINUING_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016	DROPOUTS_6_YEAR_2014 GRADUATES_4_YEAR_2016 DROPOUT_RATE_5_YEAR_2015 OTHER_COMPLETER_6_YEAR_2014 DROPOUTS_5_YEAR_2015 AMERICAN_INDIAN_ENROLLMENT_2017 CONTINUING_5_YEAR_2015 DROPOUTS_4_YEAR_2016 OTHER_COMPLETER_5_YEAR_2015"
*this loop is to make sure we can estimate on individual covariates
foreach x of local covset2{
sem (Treatment<-`x',),method(mlmv) nocapslatent vce(robust)
}
**try creating linear predictor again with full set
local covset2 "FAFSA_6_30_16 FAFSA_12_30_16 TotalProficient_2016_Social_Stud	FAFSA3_3_16 TotalPartiallyProficient_2016_Sc TotalProficient_2016_Science FEMALE_ENROLLMENT_2017 TOTAL_Graduate_COUNT_CER_2015 GRADE_12_ENROLLMENT_2017	TotalEnrolledinanIHEwithin GRADUATES_6_YEAR_2014 TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Science AFRICAN_AMERICAN_ENROLLMENT_2017	TotalNotProficient_2016_Social_S TOTAL_ENROLLMENT_2017	ASIAN_ENROLLMENT_2017 TotalPartiallyProficient_2016_So TotalDidNotMeet_2016_Social_Stud TotalMet_2016_Science GRADUATION_RATE_4_YEAR_2016	TotalGraduatesAllStudents_C	TotalNotProficient_2016_Science	Grade_12_ENROLLMENT_2016 MathScoreAverage_2016	GRADUATES_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014	MALE_ENROLLMENT_2017 SPECIAL_EDUCATION_ENROLLMENT_201 TWO_OR_MORE_RACES_ENROLLMENT_201 WHITE_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 GRADUATION_RATE_5_YEAR_2015 ECONOMIC_DISADVANTAGED_ENROLLMEN DROPOUT_RATE_6_YEAR_2014 ENGLISH_LANGUAGE_LEARNERS_ENROLL CONTINUING_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016	DROPOUTS_6_YEAR_2014 GRADUATES_4_YEAR_2016 DROPOUT_RATE_5_YEAR_2015 OTHER_COMPLETER_6_YEAR_2014 DROPOUTS_5_YEAR_2015 AMERICAN_INDIAN_ENROLLMENT_2017 CONTINUING_5_YEAR_2015 DROPOUTS_4_YEAR_2016 OTHER_COMPLETER_5_YEAR_2015"
sem (Treatment<-`covset2',),method(mlmv) nocapslatent vce(robust)
**still issues, so let's create a propensity for each covariate 
local covset2 "FAFSA_6_30_16 FAFSA_12_30_16 TotalProficient_2016_Social_Stud	FAFSA3_3_16 TotalPartiallyProficient_2016_Sc TotalProficient_2016_Science FEMALE_ENROLLMENT_2017 TOTAL_Graduate_COUNT_CER_2015 GRADE_12_ENROLLMENT_2017	TotalEnrolledinanIHEwithin GRADUATES_6_YEAR_2014 TotalMet_2016_Social_Studies TotalDidNotMeet_2016_Science AFRICAN_AMERICAN_ENROLLMENT_2017	TotalNotProficient_2016_Social_S TOTAL_ENROLLMENT_2017	ASIAN_ENROLLMENT_2017 TotalPartiallyProficient_2016_So TotalDidNotMeet_2016_Social_Stud TotalMet_2016_Science GRADUATION_RATE_4_YEAR_2016	TotalGraduatesAllStudents_C	TotalNotProficient_2016_Science	Grade_12_ENROLLMENT_2016 MathScoreAverage_2016	GRADUATES_5_YEAR_2015 GRADUATION_RATE_6_YEAR_2014	MALE_ENROLLMENT_2017 SPECIAL_EDUCATION_ENROLLMENT_201 TWO_OR_MORE_RACES_ENROLLMENT_201 WHITE_ENROLLMENT_2017 HISPANIC_ENROLLMENT_2017 GRADUATION_RATE_5_YEAR_2015 ECONOMIC_DISADVANTAGED_ENROLLMEN DROPOUT_RATE_6_YEAR_2014 ENGLISH_LANGUAGE_LEARNERS_ENROLL CONTINUING_4_YEAR_2016 DROPOUT_RATE_4_YEAR_2016 OTHER_COMPLETER_4_YEAR_2016	DROPOUTS_6_YEAR_2014 GRADUATES_4_YEAR_2016 DROPOUT_RATE_5_YEAR_2015 OTHER_COMPLETER_6_YEAR_2014 DROPOUTS_5_YEAR_2015 AMERICAN_INDIAN_ENROLLMENT_2017 CONTINUING_5_YEAR_2015 DROPOUTS_4_YEAR_2016 OTHER_COMPLETER_5_YEAR_2015"
foreach x of local covset2{
sem (Treatment<-`x',),method(mlmv) nocapslatent vce(robust)
predict p`x'
}

local renamed "TotalEnrolledinIHEwithin Grade12ENROLLMENT2016 GRADE12ENROLLMENT2017 FAFSA63016 FAFSA123016 FAFSA3316 TOTALENROLLMENT2017 MALEENROLLMENT2017 FEMALEENROLLMENT2017 AMERICANINDIANENROLLMENT2017 ASIANENROLLMENT2017 AFRICANAMERICANENROLLMENT2017 HISPANICENROLLMENT2017 WHITEENROLLMENT2017 TWOORMORERACESENROLLMENT ECONOMICDISADVANTAGEDENROLLMEN SPECIALEDUCATIONENROLLMENT ENGLISHLANGUAGELEARNERSENROLL GRADUATIONRATE4YEAR2016 DROPOUTRATE4YEAR2016 GRADUATES4YEAR2016 DROPOUTS4YEAR2016 CONTINUING4YEAR2016 OTHERCOMPLETER4YEAR2016 GRADUATIONRATE5YEAR2015 DROPOUTRATE5YEAR2015 GRADUATES5YEAR2015 DROPOUTS5YEAR2015 CONTINUING5YEAR2015 OTHERCOMPLETER5YEAR2015 GRADUATIONRATE6YEAR2014 DROPOUTRATE6YEAR2014 GRADUATES6YEAR2014 DROPOUTS6YEAR2014 OTHERCOMPLETER6YEAR2014 MathScoreAverage2016 TotalProficient2016SocialStud TotalPartiallyProficient2016So TotalNotProficient2016SocialS TotalMet2016SocialStudies TotalDidNotMeet2016SocialStud TotalProficient2016Science TotalPartiallyProficient2016Sc TotalNotProficient2016Science TotalMet2016Science TotalDidNotMeet2016Science TOTALGraduateCOUNTCER2015 TotalGraduatesAllStudents"
foreach x of local renamed{
sem (Treatment<-`x',),method(mlmv) nocapslatent vce(robust)
predict p`x'
}
local ps "pTotalEnrolledinIHEwithin pGrade12ENROLLMENT2016 pGRADE12ENROLLMENT2017 pFAFSA63016 pFAFSA123016 pFAFSA3316 pTOTALENROLLMENT2017 pMALEENROLLMENT2017 pFEMALEENROLLMENT2017 pAMERICANINDIANENROLLMENT2017 pASIANENROLLMENT2017 pAFRICANAMERICANENROLLMENT2017 pHISPANICENROLLMENT2017 pWHITEENROLLMENT2017 pTWOORMORERACESENROLLMENT pECONOMICDISADVANTAGEDENROLLMEN pSPECIALEDUCATIONENROLLMENT pENGLISHLANGUAGELEARNERSENROLL pGRADUATIONRATE4YEAR2016 pDROPOUTRATE4YEAR2016 pGRADUATES4YEAR2016 pDROPOUTS4YEAR2016 pCONTINUING4YEAR2016 pOTHERCOMPLETER4YEAR2016 pGRADUATIONRATE5YEAR2015 pDROPOUTRATE5YEAR2015 pGRADUATES5YEAR2015 pDROPOUTS5YEAR2015 pCONTINUING5YEAR2015 pOTHERCOMPLETER5YEAR2015 pGRADUATIONRATE6YEAR2014 pDROPOUTRATE6YEAR2014 pGRADUATES6YEAR2014 pDROPOUTS6YEAR2014 pOTHERCOMPLETER6YEAR2014 pMathScoreAverage2016 pTotalProficient2016SocialStud pTotalPartiallyProficient2016So pTotalNotProficient2016SocialS pTotalMet2016SocialStudies pTotalDidNotMeet2016SocialStud pTotalProficient2016Science pTotalPartiallyProficient2016Sc pTotalNotProficient2016Science pTotalMet2016Science pTotalDidNotMeet2016Science pTOTALGraduateCOUNTCER2015 pTotalGraduatesAllStudents"
foreach p of local ps{
by Treatment:sum `p'
ttest `p', by(Treatment)
} 
**the propensities based on Science and Social Studies are differing between groups, so we can trim here
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_trim1wP.dta",replace
drop if pTotalMet2016Science<.07
drop if pTotalPartiallyProficient2016Sc<.02
drop if pTotalMet2016SocialStudies<.04
drop if pTotalProficient2016SocialStud<.05
tab Treatment
**now have 6 Treatment and 12 control
local ps "pTotalEnrolledinIHEwithin pGrade12ENROLLMENT2016 pGRADE12ENROLLMENT2017 pFAFSA63016 pFAFSA123016 pFAFSA3316 pTOTALENROLLMENT2017 pMALEENROLLMENT2017 pFEMALEENROLLMENT2017 pAMERICANINDIANENROLLMENT2017 pASIANENROLLMENT2017 pAFRICANAMERICANENROLLMENT2017 pHISPANICENROLLMENT2017 pWHITEENROLLMENT2017 pTWOORMORERACESENROLLMENT pECONOMICDISADVANTAGEDENROLLMEN pSPECIALEDUCATIONENROLLMENT pENGLISHLANGUAGELEARNERSENROLL pGRADUATIONRATE4YEAR2016 pDROPOUTRATE4YEAR2016 pGRADUATES4YEAR2016 pDROPOUTS4YEAR2016 pCONTINUING4YEAR2016 pOTHERCOMPLETER4YEAR2016 pGRADUATIONRATE5YEAR2015 pDROPOUTRATE5YEAR2015 pGRADUATES5YEAR2015 pDROPOUTS5YEAR2015 pCONTINUING5YEAR2015 pOTHERCOMPLETER5YEAR2015 pGRADUATIONRATE6YEAR2014 pDROPOUTRATE6YEAR2014 pGRADUATES6YEAR2014 pDROPOUTS6YEAR2014 pOTHERCOMPLETER6YEAR2014 pMathScoreAverage2016 pTotalProficient2016SocialStud pTotalPartiallyProficient2016So pTotalNotProficient2016SocialS pTotalMet2016SocialStudies pTotalDidNotMeet2016SocialStud pTotalProficient2016Science pTotalPartiallyProficient2016Sc pTotalNotProficient2016Science pTotalMet2016Science pTotalDidNotMeet2016Science pTOTALGraduateCOUNTCER2015 pTotalGraduatesAllStudents"
egen meanPS=rowmean(`ps')
**meanPS serves as our propensity score
gen ipw=(Treatment/meanPS)+((1-Treatment)/(1-meanPS))
tab Treatment meanPS
sum meanPS
**propensity range is only .025 with essentially all treatment in the upper range and all control in lower
**thus we really only have one strata in MI
poisson FAFSA_3_3_17 Treatment [pw=ipw] , exposure(GRADE12ENROLLMENT2017) irr
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_trim2.dta",replace
**prep for appending with other states
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_trim2.dta",clear
drop Strata
gen Strata=1
gen State="MI"
egen StateStrata=concat(State Strata)
rename FAFSA_3_3_17 FAFSA3
rename Unique_ID ID
rename meanPS ps
rename GRADE12ENROLLMENT2017 enroll
tostring ID, gen(id)
drop ID
rename id ID
keep Treatment FAFSA3 ID ps Strata ipw enroll State StateStrata
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_toAppend.dta",replace
*append 
use "C:\Users\scottpw\Desktop\Consults\CollegeSummit\APPENDED1.dta", clear
append using "C:\Users\scottpw\Desktop\Consults\CollegeSummit\MI_toAppend.dta"
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\APPENDED1.dta", replace
mepoisson FAFSA3 Treatment [pw=ipw], exposure(enroll)||StateStrata:, irr
estimates store m1
mepoisson FAFSA3 Treatment [pw=ipw], exposure(enroll)||StateStrata: Treatment, irr
estimates store m2
lrtest m2 m1, stats force
**AIC and BIC indicate that allowing treatment to vary in strata is preferable
mepoisson FAFSA3 Treatment [pw=ipw], exposure(enroll)||StateStrata: Treatment, irr cov(unstr)
estimate store m3
**LR test and BIC indicate that the unstructured covariance isn't worth it
**so model 2 with treatment varying across strata and i.i.d. covariance matrix for random effects will be used
mepoisson FAFSA3 Treatment [pw=ipw], exposure(enroll)||StateStrata: Treatment, irr
drop _est_m3 _est_m2 _est_m1
save "C:\Users\scottpw\Desktop\Consults\CollegeSummit\APPENDED1.dta", replace

